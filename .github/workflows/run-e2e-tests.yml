name: Capture Vercel preview URL

on:
  issue_comment:
    types: [edited]

jobs:
  capture_vercel_preview_url:
    name: Capture Vercel preview URL
    runs-on: "ubuntu-latest"
    steps:
      - uses: aaimio/vercel-preview-url-action@v1
        id: vercel_preview_url
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt install jq

      - name: Get main commit sha
        id: github_api
        run: |
          echo "::set-output name=MAIN_SHA::$(curl -s '${{ github.event.issue.pull_request.url }}' | jq -r '.head.sha')"

      - name: Start crusher tests
        run: |
          curl --location --request POST 'https://backend.crusher.dev/projects/258/tests/actions/run' \
          --header 'Content-Type: application/x-www-form-urlencoded' \
          --cookie "token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyODIsInRlYW1faWQiOjIxOSwiaWF0IjoxNjMzNDkyOTc5LCJleHAiOjE2NjUwMjg5Nzl9.fftN81qi0yJEDs9HnqiW4tElDMWp4dTHnAofnABmZuE" \
          --data-urlencode 'githubRepoName=crusherdev/crusher' \
          --data-urlencode 'host=${{ steps.vercel_preview_url.outputs.vercel_preview_url }}' \
          --data-urlencode 'githubCommitId=${{steps.github_api.outputs.MAIN_SHA}}'
